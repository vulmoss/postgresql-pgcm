# postgresql repmgr部署
## 0x01 
搭建repmgr高可用架构，需要先部署postgresql，同步的节点不需要创建数据库，
会从生产节点复制过去。
需要安装依赖包：`flexjson-c-devellibcurl-devel`

```
[root@pg16postgres]#wget
https://www.repmgr.org/download/repmgr-5.4.1.tar.gz
[postgres@pg16~]$echo$PATH
/usr/local/pgsql/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:
/usr/sbin:/home/postgres/.local/bin:/home/postgres/bin
[postgres@pg16~]$exit
logout
[root@pg16~]#export
PATH=/usr/local/pgsql/bin:/usr/local/bin:/bin:/usr/bin:/usr/local
/sbin:/usr/sbin:/home/postgres/.local/bin:/home/postgres/bin
[root@pg16~]#cd/root/repmgr-5.4.1
[root@pg16repmgr-5.4.1]#./configure
checkingforasedthatdoesnottruncateoutput.../bin/sed
checkingforpg_config.../usr/local/pgsql/bin/pg_config
configure:buildingagainstPostgreSQL16.2
checkingforgnused...no
checkingforgsed...no
checkingforsed...yes
configure:creating./config.status
config.status:creatingMakefile
config.status:creatingMakefile.global
config.status:creatingconfig.h
config.status:config.hisunchanged
[root@pg16repmgr-5.4.1]#make&&makeinstall
```

## 0x02 
配置postgres用户互信：使用sshUserSetup.sh脚本

```
./sshUserSetup.sh-userroot-hosts"pg16reppg16stdpg16"-
advanced-noPromptPassphrase#在生产节点执行即可
1
chmod600/home/postgres/.ssh/config#每个节点执行
```

## 0x03 
配置PGSQL创建repmgr用户和数据库，并授权管理员权限（生产节点）

```
postgres=#createuserrepmgrwithsuperuserpassword'repmgr'
connectionlimit20;
postgres=#createdatabaserepmgrownerrepmgr;\
postgres=#alteruserrepmgrsetsearch_pathtorepmgr,"$user",
public;
```
## 0x04 
postgresql.conf配置参数修改
```
[postgres@pg16data]$catpostgresql.conf|grep
shared_preload_libraries
#shared_preload_libraries=''#(changerequiresrestart)
shared_preload_libraries=
'repmgr,pg_stat_statements,pg_stat_monitor,auto_explain'
[postgres@pg16data]$catpostgresql.conf|grep
max_replication_slots
#max_replication_slots=10#maxnumberofreplicationslots
max_replication_slots=100
[postgres@pg16data]$catpostgresql.conf|grepmax_wal_senders
#max_wal_senders=10#maxnumberofwalsenderprocesses
max_wal_senders=10
[postgres@pg16data]$
[postgres@pg16data]$
[postgres@pg16data]$catpostgresql.conf|grepwal_log_hints
#wal_log_hints=off#alsodofullpagewritesofnon-
criticalupdates
wal_log_hints=on
```
## 0x05
生产库pghba.conf配置文件如下：
```
#"local"isforUnixdomainsocketconnectionsonly
2
localallall
trust
#IPv4localconnections:
hostallall127.0.0.1/32
trust
hostallall0.0.0.0/0
trust
#IPv6localconnections:
hostallall::1/128
trust
#Allowreplicationconnectionsfromlocalhost,byauserwith
the
#replicationprivilege.
localreplicationall
trust
hostreplicationall127.0.0.1/32
trust
hostreplicationall::1/128
trust
hostrepmgrrepmgr0.0.0.0/0trust
hostreplicationrepuser0.0.0.0/0trust
hostreplicationrepmgr0.0.0.0/0trust
```
## 0x06
配置.pgpass文件
```
[postgres@pg16data]$cat/home/postgres/.pgpass
192.168.1.15:5432:repmgr:repmgr:repmgr
192.168.1.14:5432:repmgr:repmgr:repmgr
192.168.1.13:5432:repmgr:repmgr:repmgr
```
重启postgresql数据库服务
`systemctl restart postgresql.service`

## 0x07
生产节点repmgr.conf参数文件

```
node_id=1
node_name='pg16'
conninfo='host=192.168.1.15port=5432user=repmgrdbname=repmgr
connect_timeout=2'
data_directory='/data/postgres/data'
failover='automatic'
promote_command='/usr/local/pgsql16.2/bin/repmgrstandbypromote
--config-file=/data/repmgr/repmgr.conf--log-to-file'
follow_command='/usr/local/pgsql16.2/bin/repmgrstandbyfollow--
config-file=/data/repmgr/repmgr.conf--log-to-file--upstream-
node-id=%n'
monitoring_history=yes
connection_check_type=ping
reconnect_attempts=6
reconnect_interval=10
standby_disconnect_on_failover=true
repmgrd_pid_file='/data/repmgr/repmgrd.pid'
repmgrd_service_start_command='/usr/local/pgsql16.2/bin/repmgrd-
f/data/repmgr/repmgr.confstart'
repmgrd_service_stop_command='kill-9`cat
/data/repmgr/repmgrd.pid`'
log_level=INFO
log_file='/data/repmgr/repmgrd.log'
log_status_interval=10
```
## 0x08
standby节点repmgr.conf文件

```
[postgres@pg16std~]$cat/data/repmgr/repmgr.conf
node_id=2
node_name='pg16std'
conninfo='host=192.168.1.14port=5432user=repmgrdbname=repmgr
connect_timeout=2'
data_directory='/data/postgres/data'
failover='automatic'
promote_command='/usr/local/pgsql16.2/bin/repmgrstandbypromote
--config-file=/data/repmgr/repmgr.conf--log-to-file'
follow_command='/usr/local/pgsql16.2/bin/repmgrstandbyfollow--
config-file=/data/repmgr/repmgr.conf--log-to-file--upstream-
node-id=%n'
monitoring_history=yes
connection_check_type=ping
reconnect_attempts=6
reconnect_interval=10
standby_disconnect_on_failover=true
repmgrd_pid_file='/data/repmgr/repmgrd.pid'
repmgrd_service_start_command='/usr/local/pgsql16.2/bin/repmgrd-
f/data/repmgr/repmgr.confstart'
repmgrd_service_stop_command='kill-9`cat
/data/repmgr/repmgrd.pid`'
log_level=INFO
log_file='/data/repmgr/repmgrd.log'
log_status_interval=10
```
## 0x09
注册主节点

```
[postgres@pg16repmgr]$repmgr-f/data/repmgr/repmgr.conf
primaryregister
INFO:connectingtoprimarydatabase...
NOTICE:attemptingtoinstallextension"repmgr"
NOTICE:"repmgr"extensionsuccessfullyinstalled
NOTICE:primarynoderecord(ID:1)registered
[postgres@pg16repmgr]$repmgr-f/data/repmgr/repmgr.conf
clustershow
ID|Name|Role|Status|Upstream|Location|Priority
|Timeline|Connectionstring
----+------+---------+-----------+----------+----------+---------
-+----------+----------------------------------------------------
---------------------
1|pg16|primary|*running||default|100
|1|host=192.168.1.15port=5432user=repmgr
dbname=repmgrconnect_timeout=2
[postgres@pg16repmgr]$
```
## 0x0a
克隆standby节点

```
[postgres@pg16stddata]$repmgr-hpg16-Urepmgr-drepmgr-p
5432-f/data/repmgr/repmgr.confstandbyclone--dry-run
NOTICE:destinationdirectory"/data/postgres/data"provided
INFO:connectingtosourcenode
DETAIL:connectionstringis:host=pg16user=repmgrport=5432
dbname=repmgr
DETAIL:currentinstallationsizeis544MB
INFO:"repmgr"extensionisinstalledindatabase"repmgr"
INFO:replicationslotusagenotrequested;noreplicationslot
willbesetupforthisstandby
INFO:parameter"max_wal_senders"setto10
NOTICE:checkingforavailablewalsendersonthesourcenode(2
required)
INFO:sufficientwalsendersavailableonthesourcenode
DETAIL:2required,10available
NOTICE:checkingreplicationconnectionscanbemadetothe
sourceserver(2required)
INFO:requirednumberofreplicationconnectionscouldbemadeto
thesourceserver
DETAIL:2replicationconnectionsrequired
NOTICE:standbywillattachtoupstreamnode1
HINT:considerusingthe-c/--fast-checkpointoption
INFO:wouldexecute:
pg_basebackup-l"repmgrbasebackup"-D/data/postgres/data-
hpg16-p5432-Urepmgr-Xstream
INFO:allprerequisitesfor"standbyclone"aremet
```
没有报错后，克隆

```
[postgres@pg16stddata]$repmgr-hpg16-Urepmgr-drepmgr-p
5432-f/data/repmgr/repmgr.confstandbyclone
NOTICE:destinationdirectory"/data/postgres/data"provided
INFO:connectingtosourcenode
DETAIL:connectionstringis:host=pg16user=repmgrport=5432
dbname=repmgr
DETAIL:currentinstallationsizeis543MB
INFO:replicationslotusagenotrequested;noreplicationslot
willbesetupforthisstandby
NOTICE:checkingforavailablewalsendersonthesourcenode(2
required)
NOTICE:checkingreplicationconnectionscanbemadetothe
sourceserver(2required)
INFO:checkingandcorrectingpermissionsonexistingdirectory
"/data/postgres/data"
NOTICE:startingbackup(usingpg_basebackup)...
HINT:thismaytakesometime;considerusingthe-c/--fast-
checkpointoption
INFO:executing:
pg_basebackup-l"repmgrbasebackup"-D/data/postgres/data-
hpg16-p5432-Urepmgr-Xstream
NOTICE:standbyclone(usingpg_basebackup)complete
NOTICE:youcannowstartyourPostgreSQLserver
HINT:forexample:pg_ctl-D/data/postgres/datastart
HINT:afterstartingtheserver,youneedtoregisterthis
standbywith"repmgrstandbyregister"
```
启动standby上的pg实例

`systemctlstartpostgresql.service`

## 0x0b
注册从库节点：
```
[postgres@pg16std~]$repmgr-f/data/repmgr/repmgr.confstandby
register
INFO:connectingtolocalnode"pg16std"(ID:2)
INFO:connectingtoprimarydatabase
WARNING:--upstream-node-idnotsupplied,assumingupstreamnode
isprimary(nodeID:1)
INFO:standbyregistrationcomplete
NOTICE:standbynode"pg16std"(ID:2)successfullyregistered
[postgres@pg16std~]$repmgr-f/data/repmgr/repmgr.confcluster
show
ID|Name|Role|Status|Upstream|Location|
Priority|Timeline|Connectionstring
----+---------+---------+-----------+----------+----------+------
----+----------+-------------------------------------------------
------------------------
1|pg16|primary|*running||default|100
|1|host=192.168.1.15port=5432user=repmgr
dbname=repmgrconnect_timeout=2
2|pg16std|standby|running|pg16|default|100
|1|host=192.168.1.14port=5432user=repmgr
dbname=repmgrconnect_timeout=2
```
## 0x0c
测试：在主库修改数据，查看是否同步到standby上

```
postgres=#\clyradblyra_aq
Youarenowconnectedtodatabase"lyradb"asuser"lyra_aq".
lyradb=>select*from"ApiClaims";
id|type|apiresourceid|type2|newcolumns
----+----------+---------------+-------+------------
1|name|2||
2|email|2||
3|testok|3||
4|testtest|3||
(4rows)
lyradb=>
lyradb=>select*from"ApiClaims";
id|type|apiresourceid|type2|newcolumns
----+----------+---------------+-------+------------
1|name|2||
2|email|2||
3|testok|3||
4|testtest|3||
5|test5|1||
(5rows)
lyradb=>
lyradb=>
^
lyradb=>deletefrom"ApiClaims"whereid=5;
ERROR:cannotexecuteDELETEinaread-onlytransaction
lyradb=>\q
```